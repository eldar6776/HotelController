Migracija Hotel Controller-a na ESP32 (WT32-ETH01)Ovaj projekat predstavlja potpunu softversku i hardversku migraciju postojećeg "Hotel Controller" sistema sa STM32F429 platforme na moderniju ESP32 (WT32-ETH01) platformu.Glavni cilj je zadržati 100% kompatibilnost sa postojećim RS485 protokolom i HTTP CGI komandama. Zbog kompleksnosti sistema i nedostatka naprednih in-circuit debagera (npr. Keil MDK), monolitna HC_Service "superloop" arhitektura je napuštena.Umjesto nje, projekat je refaktorisan u modularnu FreeRTOS arhitekturu baziranu na nezavisnim "Menadžerima" (servisima).1. Ključne ZnačajkePlatforma: ESP32 (WT32-ETH01) sa Arduino frameworkom.Mreža: Primarno Ethernet (ETH), sa Wi-Fi (WiFiManager) kao backup opcijom.Komunikacija: RS485 (Serial2) dispečer zadatak koji upravlja sa više logičkih menadžera.HTTP Server: AsyncWebServer koji u potpunosti replicira stare CGI GET komande i HTTP2RS485 blokirajuću logiku.Skladištenje Konfiguracije: I2C EEPROM (24C1024) za konfiguraciju, listu RS485 adresa i cirkularni log (head/tail).Skladištenje Fajlova: Eksterni SPI Flash (W25Q512, 64MB) za skladištenje velikih update fajlova (npr. 11.4MB QSPI fajl).Grafika: Podrška za DWIN serijski displej (UART) za prikaz logova i statusa.2. Hardverska Arhitektura (Mapa Pinova v11)Ovo je finalna, zaključana mapa pinova koja koristi jedan SPI Flash čip (W25Q512) i vraća Status LED u funkciju.FunkcijaPeriferijaPin na pločiGPIOObrazloženjeKritični SatEMAC CLKIO0GPIO0Interno zauzeto. Ne koristiti!RS485Serial2 RXRXDGPIO5Zauzeto (Hardverski UART)RS485Serial2 TXTXDGPIO17Zauzeto (Hardverski UART)RS485Driver Enable485_ENGPIO33Namjenski pin na ploči.I2C (EEPROM)I2C SDAIO14GPIO14Zauzeto (Hardverski I2C)I2C (EEPROM)I2C SCLIO15GPIO15Zauzeto (Hardverski I2C)DWIN DisplejSerial0 TXTX0GPIO1Trajno zauzeto (Debug / DWIN).DWIN DisplejSerial0 RXRX0GPIO3Trajno zauzeto (Debug / DWIN).Ext. FlashSPI SCK (Sat)IO12GPIO12Namjenski SPI za Flash (W25Q512).Ext. FlashSPI MOSI (Izlaz)IO4GPIO4Namjenski SPI za Flash.Ext. FlashSPI MISO (Ulaz)IO36GPIO36Namjenski SPI za Flash (Input-Only pin).Ext. FlashSPI CSCFGGPIO32Chip Select za Flash.Status LEDOn-board LEDIO2GPIO2Vraćeno u funkciju za dijagnostiku.WLAN ResetDugmeIO39GPIO39Input-Only pin (reset WiFi postavki).RasvjetaRelej(Nema)VIRTUALNI PINSoftverska logika (za budući I2C Expander).3. Softverska Arhitektura (Pregled Modula)Projekat je podijeljen na sljedeće logičke module, koji se nalaze u src/ i include/ direktorijima:main.cppGlavna ulazna tačka. Odgovoran samo za inicijalizaciju modula i pokretanje FreeRTOS zadataka. loop() sadrži samo ne-blokirajuće servisne pozive.ProjectConfig.hDefiniše hardversku Mapu Pinova (v11) i fiksnu Memorijsku Mapu za EEPROM i SPI Flash.NetworkManager.h / .cppUpravlja ETH i Wi-Fi konekcijom, pokreće NTP sinhronizaciju (configTzTime) i Ping Watchdog.EepromStorage.h / .cppUpravlja I2C (Wire) komunikacijom sa 24C1024 EEPROM-om.Implementira head/tail loger.Čita/piše Konfiguraciju i Listu Adresa.SpiFlashStorage.h / .cppUpravlja SPI komunikacijom sa W25Q512 (64MB) Flash čipom.Pruža API za Erase, WriteChunk i ReadChunk za velike FW fajlove.Rs485Service.h / .cppSrce aplikacije. Ovo je centralni FreeRTOS zadatak (dispečer) koji serijalizuje pristup RS485 magistrali.Validira SOH/CRC/EOT pakete i prosljeđuje ih menadžerima.HttpServer.h / .cppPokreće AsyncWebServer na oba interfejsa (ETH/WiFi).Replicira sve sysctrl.cgi GET komande.Implementira POST endpoint za upload fajlova na SpiFlashStorage.Poziva druge menadžere za izvršavanje komandi.HttpQueryManager.h / .cppReplicira blokirajuću HTTP2RS485 logiku.Koristi FreeRTOS semafore da blokira HttpServer zadatak dok čeka odgovor od Rs485Service.LogPullManager.h / .cppImplementira standardni "pull" mehanizam (logika UPD_RC_STAT i UPD_LOG iz HC_Service).Periodično poziva HC_GetNextAddr() i šalje upite uređajima.UpdateManager.h / .cppImplementira state machine za ažuriranje firmvera.Čita fajlove sa SpiFlashStorage i šalje ih paket po paket preko Rs485Service.TimeSync.h / .cppNiskoprioritetni modul koji periodično šalje SET_RTC_DATE_TIME broadcast na RS485 magistralu.VirtualGpio.h / .cppUpravlja stanjem "virtuelnih" pinova (Rasvjeta, STATUS_LED_PIN).Ovaj modul će u budućnosti biti proširen da upravlja I2C GPIO Expanderom.4. Strategija Skladištenja PodatakaUmjesto uSD kartice i FAT fajl sistema, ovaj projekat koristi kombinaciju dva skladišta sa fiksnom memorijskom mapom:I2C EEPROM (24C1024 - 128KB):Blok 1 (Konfiguracija): IP adrese, RS485 adrese, System ID...Blok 2 (Lista Adresa): Lista od ~400 adresa za LogPullManager.Blok 3 (Logovi): Cirkularni bafer (head/tail) za sve dolazne logove sa magistrale.SPI Flash (W25Q512 - 64MB):Koristi se isključivo za skladištenje velikih binarnih fajlova (FW, BL, Slike, QSPI) koji se šalju na RS485 bus.Svaki fajl ima definisan fiksni "slot" (adresu) unutar ProjectConfig.h.5. Razvojni Proces (Faze)FAZA 1 (Razvoj Jezgra):Uređaj je spojen USB kablom. Serial0 (GPIO1/3) se koristi za Serial.println() u VS Code. DWIN Displej je isključen.Razvijaju se i testiraju svi moduli (EepromStorage, Rs485Service, HttpServer...).FAZA 2 (Integracija Grafike):Kada je Faza 1 stabilna, USB kabl se isključuje.DWIN Displej se fizički spaja na TX0/RX0 pinove.Serial.println() poruke sada automatski idu na DWIN.Dodaje se kod za Serial.read() za primanje komandi sa DWIN-a.6. Nomenklatura KodaProjekat koristi striktnu nomenklaturu za svu kodu:KategorijaStil (Format)PrimjerFajlovi (Moduli)PascalCaseRs485Service.hTipovi (Klase, Strukture)PascalCaseclass EepromStorageFunkcije / MetodePascalCasevoid Initialize()Globalne Varijableg_snake_caseg_rs485_task_handleČlanske Varijable (Klase)m_snake_caseuint16_t m_write_index;Lokalne VarijablecamelCaseint localCounterKonstante / MakroiALL_CAPS_SNAKE_CASERS485_DE_PIN